/*---------------------------------------------------------------------------*\
  =========                 |
  \\      /  F ield         | OpenFOAM: The Open Source CFD Toolbox
   \\    /   O peration     |
    \\  /    A nd           | www.openfoam.com
     \\/     M anipulation  |
-------------------------------------------------------------------------------
    Computes the reconstructed distance function (RDF) from a volume-fraction
    field using geometricVoF reconstruction.

\*---------------------------------------------------------------------------*/

#include "RDF.H"
#include "addToRunTimeSelectionTable.H"

namespace Foam
{
namespace functionObjects
{
    defineTypeNameAndDebug(RDF, 0);
    addToRunTimeSelectionTable(functionObject, RDF, dictionary);
}
}


// * * * * * * * * * * * * * * Private Member Functions  * * * * * * * * * * //
bool Foam::functionObjects::RDF::calc()
{
  /*if (!obr().foundObject<volScalarField>(alphaName_))
    {
        WarningInFunction << "alpha field not found: " << alphaName_ << nl;
        return false;
	}*/

  // const volScalarField& alpha = obr().lookupObject<volScalarField>(alphaName_);

    reconstructionSchemes& recon =
      obr().lookupObjectRef<reconstructionSchemes>("reconstructionScheme");

  //recon.reconstruct(false);
  //recon.reconstruct(true);
  
    const volVectorField& interfaceCentres = recon.centre();
    const volVectorField& interfaceNormals = recon.normal();
    zoneDistribute& exchangeFields = zoneDistribute::New(mesh_);

    boolList nextToInterface(mesh_.nCells(), false);

    reconstructedDistanceFunction rdf(mesh_);
    rdf.constructRDF(nextToInterface, interfaceCentres, interfaceNormals, exchangeFields, true);
    rdf.correctBoundaryConditions(); // update proc patches
    
    return true;
}

bool Foam::functionObjects::RDF::execute()
{
    // Typically do nothing here, only act at write time
    return true;
}

bool Foam::functionObjects::RDF::write()
{
    // Call calc() to actually compute and write RDF at output times
    return calc();
}

// * * * * * * * * * * * * * * * * Constructors  * * * * * * * * * * * * * * //

Foam::functionObjects::RDF::RDF
(
    const word& name,
    const Time& runTime,
    const dictionary& dict
)
:
    fvMeshFunctionObject(name, runTime, dict)
    // alphaName_(dict.lookupOrDefault<word>("alpha", "alpha.water"))
{}


// ************************************************************************* //
